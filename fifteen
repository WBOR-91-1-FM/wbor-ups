#!/usr/bin/env bash
set -o errexit -o nounset -o pipefail -o errtrace

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/common.sh"
setup_logging "/var/log/wbor-ups/fifteen.log"
set -o xtrace

###############################################################################
# fifteen
#
# Called 15 minutes after onbattery.
# Sends a follow-up email, GroupMe, and Discord embed.
###############################################################################

source "$SCRIPT_DIR/discord_embed.sh"
source "$SCRIPT_DIR/groupme.sh"

: "${SYSADMIN:?Need SYSADMIN}" "${APCUPSD_MAIL:?Need APCUPSD_MAIL}"
: "${GROUPME_API_URL:?Need GROUPME_API_URL}"
: "${MGMT_BOT_ID:?Need MGMT_BOT_ID}" "${CLUBWIDE_BOT_ID:?Need CLUBWIDE_BOT_ID}"

HOSTNAME="$(hostname)"
TIMELEFT="$(get_timeleft)"
MSG_TITLE="$HOSTNAME UPS - 15-Min Update"

# Email
{
  echo "To: $SYSADMIN"
  echo "From: wbor-smtp@bowdoin.edu"
  echo "Subject: $MSG_TITLE"
  echo ""
  echo "Estimated time remaining: $TIMELEFT."
} | sudo "$APCUPSD_MAIL" "$SYSADMIN" || {
  echo "Warning: Email send failed, continuing with webhooks" >&2
}

# GroupMe - Management
groupme_mgmt "15-Min Update: $TIMELEFT remaining"

# GroupMe - Clubwide
groupme_club "15-Min Update: $TIMELEFT remaining"

# Discord embed
fields='[{"name":"Time Left","value":"'"$TIMELEFT"'","inline":true}]'
send_discord_embed "$MSG_TITLE" "Battery has been on for 15 minutes." "$fields"

exit 0
