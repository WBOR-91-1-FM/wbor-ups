#!/usr/bin/env bash
set -o errexit -o nounset -o pipefail -o errtrace

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/common.sh"
setup_logging "/var/log/wbor-ups/onbattery.log"

###############################################################################
# onbattery
#
# Called by apcupsd when UPS switches to battery.
# Sends alerts and schedules fifteen.
###############################################################################

source "$SCRIPT_DIR/discord_embed.sh"
source "$SCRIPT_DIR/groupme.sh"

# Ensure run directory
RUN_DIR=$(ensure_dir_or_tmp "/var/run/wbor-ups")
PID_FILE="$RUN_DIR/fifteen.pid"

: "${SYSADMIN:?Need SYSADMIN}" "${APCUPSD_MAIL:?Need APCUPSD_MAIL}"
: "${GROUPME_API_URL:?Need GROUPME_API_URL}"
: "${MGMT_BOT_ID:?Need MGMT_BOT_ID}" "${CLUBWIDE_BOT_ID:?Need CLUBWIDE_BOT_ID}"
: "${GENERATOR_DESC:="the building's backup generator"}"

# Avoid duplicate scheduling
if [[ -f "$PID_FILE" && $(kill -0 "$(cat "$PID_FILE")" 2>/dev/null) ]]; then
    echo "15-Min follow-up already scheduled (PID $(cat "$PID_FILE")). Exiting."
    exit 0
fi

HOSTNAME="$(hostname)"
TIMELEFT="$(get_timeleft)"
MSG_TITLE="$HOSTNAME UPS - Power Failure"

# Email
{
    echo "To: $SYSADMIN"
    echo "From: wbor-smtp@bowdoin.edu"
    echo "Subject: $MSG_TITLE"
    echo ""
    echo "Battery backup deployed. Estimated time remaining: $TIMELEFT."
    echo ""
    echo "Note: This alert may occur during $GENERATOR_DESC startup; take it with a grain of salt."
} | sudo "$APCUPSD_MAIL" "$SYSADMIN" || {
    echo "Warning: Email send failed, continuing with webhooks" >&2
}

# GroupMe - Management
groupme_mgmt "!!!\n\n$MSG_TITLE\nEstimated time: $TIMELEFT\n\nNote: This alert may occur during $GENERATOR_DESC startup; take it with a grain of salt."

# GroupMe - Clubwide
groupme_club "Station Power Loss\nBattery backup. Time left: $TIMELEFT\n\nNote: This alert may occur during $GENERATOR_DESC startup; take it with a grain of salt."

# Discord embed
fields='[{"name":"Host","value":"'"$HOSTNAME"'","inline":true},{"name":"Time Left","value":"'"$TIMELEFT"'","inline":true}]'
send_discord_embed "$MSG_TITLE" "Battery backup active." "$fields"

schedule_fifteen "$RUN_DIR" "/etc/apcupsd/fifteen"

exit 0
